import React, { useState, useEffect } from 'react';
import { Capacitor } from '@capacitor/core';
import { App as CapacitorApp } from '@capacitor/app';
import { Browser } from '@capacitor/browser';
import { useAuth } from './contexts/AuthContext';
import { useFirebase } from './hooks/useFirebase';
import { useSubscriptionAccess } from './hooks/useSubscriptionAccess';
import { ToastMessage } from './types';

// Components
import Dashboard from './components/Dashboard';
import TransactionForm from './components/TransactionForm';
import ContentModal from './components/ContentModal';
import ToastContainer from './components/Toast';
import MobileBottomNav from './components/MobileBottomNav';
import PaywallModal from './components/PaywallModal';
import MobileMenu from './components/MobileMenu';
import AuthLogin from './components/Auth/AuthLogin';
import AuthRegister from './components/Auth/AuthRegister';
import PricingPage from './components/PricingPage';
import ProfilePage from './components/ProfilePage';
import SettingsPage from './components/SettingsPage';
import GoalsPage from './components/GoalsPage';
import AiAdvisor from './components/AiAdvisor';
import { PublicHome } from './components/PublicPages';
import { 
  RentVsFinanceTool, 
  DebtOptimizerTool, 
  FireCalculatorTool, 
  InflationTool, 
  DividendsTool,
  CompoundInterestTool 
} from './components/Tools';

// Tela de Boas-vindas do APP (Só aparece no celular)
const AppWelcomeScreen: React.FC<{ onLogin: () => void, onRegister: () => void }> = ({ onLogin, onRegister }) => (
  <div className="flex flex-col items-center justify-center min-h-screen bg-[#0f172a] p-6 text-center animate-in fade-in">
    <div className="flex items-center gap-3 mb-2">
       <img src="/icon.png" alt="Logo" className="w-12 h-12 rounded-xl shadow-lg shadow-sky-500/20" />
       <h1 className="text-2xl font-black text-sky-400 tracking-tight">Finanças Pro Invest</h1>
    </div>
    <p className="text-emerald-500 text-sm font-bold uppercase tracking-widest mb-12">Gerenciador Financeiro</p>
    <div className="w-full space-y-4 max-w-sm">
      <button onClick={onLogin} className="w-full py-4 bg-sky-500 text-white rounded-2xl font-bold text-lg shadow-lg">Entrar</button>
      <button onClick={onRegister} className="w-full py-4 bg-slate-800 border border-slate-700 text-white rounded-2xl font-bold text-lg">Criar conta</button>
    </div>
  </div>
);

const App: React.FC = () => {
  const { user, isAuthenticated, loading: authLoading } = useAuth();
  const { lancamentos, saveLancamento, deleteLancamento, userMeta, usagePercentage, isLimitReached } = useFirebase(user?.uid || 'guest');
  const { isPro, isPremium } = useSubscriptionAccess();
  const isNative = Capacitor.isNativePlatform();

  const [currentTool, setCurrentTool] = useState<string>(() => {
    if (Capacitor.isNativePlatform()) return 'manager';
    const path = window.location.pathname;
    if (path.includes('/pricing')) return 'pricing';
    if (path.includes('/login')) return 'login';
    if (path.includes('/register')) return 'register';
    return 'home';
  });

  const [activeModal, setActiveModal] = useState<string | null>(null);
  const [toasts, setToasts] = useState<ToastMessage[]>([]);
  const [isPrivacyMode, setIsPrivacyMode] = useState(false);
  const [goals, setGoals] = useState<any[]>([]);

  // --- FUNÇÕES DE TOAST (RESTAURADAS) ---
  const addToast = (msg: string, type: 'success' | 'error') => {
    setToasts(prev => [...prev, { id: Math.random().toString(), message: msg, type }]);
  };
  const removeToast = (id: string) => setToasts(prev => prev.filter(t => t.id !== id));

  const navigateTo = (tool: string) => {
    setCurrentTool(tool);
    window.scrollTo(0, 0);
    if (!isNative) {
        const path = tool === 'home' ? '/' : `/${tool}`;
        window.history.pushState({}, '', path);
    }
  };

  const handleAddTransaction = async (t: any) => {
    try {
      await saveLancamento(t);
      addToast('Salvo com sucesso!', 'success');
      setActiveModal(null);
    } catch (e: any) {
      if (e.message === 'LIMIT_REACHED') setActiveModal('paywall');
      else addToast('Erro ao salvar.', 'error');
    }
  };

  if (authLoading) return <div className="min-h-screen bg-[#020617] flex items-center justify-center text-sky-500 font-bold tracking-widest">CARREGANDO ECOSSISTEMA...</div>;

  if (isNative && !isAuthenticated) {
     if (currentTool === 'register') return <AuthRegister onSuccess={() => navigateTo('manager')} onSwitchToLogin={() => navigateTo('login')} />;
     if (currentTool === 'login') return <AuthLogin onSuccess={() => navigateTo('manager')} onSwitchToRegister={() => navigateTo('register')} />;
     return <AppWelcomeScreen onLogin={() => setCurrentTool('login')} onRegister={() => setCurrentTool('register')} />;
  }

  const renderContent = () => {
    const wrap = (comp: React.ReactNode) => <div className="pt-20 lg:pt-24 pb-32 animate-in fade-in duration-500">{comp}</div>;

    switch(currentTool) {
       case 'login': return wrap(<AuthLogin onSuccess={() => navigateTo('manager')} onSwitchToRegister={() => navigateTo('register')} />);
       case 'register': return wrap(<AuthRegister onSuccess={() => navigateTo('manager')} onSwitchToLogin={() => navigateTo('login')} />);
       case 'manager': return wrap(<Dashboard transactions={lancamentos} onDeleteTransaction={deleteLancamento} onOpenForm={() => setActiveModal('transaction')} userMeta={userMeta} usagePercentage={usagePercentage} isPremium={isPro} isLimitReached={isLimitReached} onShowPaywall={() => setActiveModal('paywall')} isPrivacyMode={isPrivacyMode} />);
       case 'pricing': return wrap(<PricingPage onNavigate={navigateTo} currentPlan={isPremium ? 'premium' : isPro ? 'pro' : 'free'} onBack={() => navigateTo('home')} />);
       case 'fire': return wrap(<FireCalculatorTool onNavigate={navigateTo} isPrivacyMode={isPrivacyMode} />);
       case 'compound': return wrap(<CompoundInterestTool onNavigate={navigateTo} isPrivacyMode={isPrivacyMode} />);
       case 'inflation': return wrap(<InflationTool onNavigate={navigateTo} isPrivacyMode={isPrivacyMode} />);
       case 'rent_vs_buy': return wrap(<RentVsFinanceTool onNavigate={navigateTo} isPrivacyMode={isPrivacyMode} />);
       case 'debt': return wrap(<DebtOptimizerTool onNavigate={navigateTo} isPrivacyMode={isPrivacyMode} />);
       case 'dividends': return wrap(<DividendsTool onNavigate={navigateTo} isPrivacyMode={isPrivacyMode} />);
       case 'ai_chat': return wrap(<AiAdvisor transactions={lancamentos} currentCalcResult={null} goals={goals} currentTool="manager" />);
       case 'perfil': return wrap(<ProfilePage onNavigateHome={() => navigateTo('home')} />);
       case 'settings': return wrap(<SettingsPage onBack={() => navigateTo('home')} />);
       case 'blog': return wrap(<div className="max-w-4xl mx-auto px-4 text-white"><h1 className="text-3xl font-black mb-6">Academia Pro Invest</h1><p className="text-slate-400">Conteúdo educacional em fase de curadoria.</p><button onClick={() => navigateTo('home')} className="mt-8 text-sky-400">← Voltar</button></div>);
       case 'home': return <PublicHome onNavigate={navigateTo} onStartNow={() => navigateTo('register')} />;
       default: return <PublicHome onNavigate={navigateTo} onStartNow={() => navigateTo('register')} />;
    }
  };

  return (
    <div className="min-h-screen bg-[#020617] text-slate-200 flex flex-col font-sans">
       <header className="fixed top-0 left-0 w-full z-[100] bg-[#020617]/95 backdrop-blur-md border-b border-slate-800 h-16 flex items-center justify-between px-4 lg:px-8 shadow-2xl">
          <div className="flex items-center gap-2 cursor-pointer" onClick={() => navigateTo('home')}>
              <img src="/icon.png" alt="Logo" className="w-8 h-8 rounded-lg" />
              <h1 className="text-lg font-black text-sky-400 tracking-tight">Finanças Pro Invest</h1>
          </div>
          <div className="flex gap-4 items-center font-bold text-sm">
               <button onClick={() => navigateTo('compound')} className="text-slate-400 hover:text-white hidden md:block">Simulador</button>
               <button onClick={() => navigateTo('pricing')} className="text-slate-400 hover:text-white">Planos</button>
               {isAuthenticated ? (
                 <button onClick={() => navigateTo('manager')} className="text-emerald-400 border border-emerald-500/30 px-3 py-1 rounded-lg hover:bg-emerald-500/10">Painel</button>
               ) : (
                 <button onClick={() => navigateTo('login')} className="bg-sky-600 px-4 py-1.5 rounded-lg text-white hover:bg-sky-500">Entrar</button>
               )}
          </div>
       </header>

       <main className="flex-grow">{renderContent()}</main>

       {isNative && <MobileBottomNav currentTool={currentTool} onNavigate={setCurrentTool} onOpenMore={() => setActiveModal('menu_mobile')} onAdd={() => setActiveModal('transaction')} />}
       
       {/* Componente que causou o erro agora tem as funções definidas acima */}
       <ToastContainer toasts={toasts} removeToast={removeToast} />
       
       <ContentModal isOpen={activeModal === 'transaction'} onClose={() => setActiveModal(null)} title="Novo Lançamento">
          <TransactionForm onSave={handleAddTransaction} onCancel={() => setActiveModal(null)} expenseCategories={['Alimentação', 'Moradia', 'Transporte', 'Lazer', 'Saúde']} incomeCategories={['Salário', 'Investimentos', 'Freelance']} onUpdateExpenseCategories={()=>{}} onUpdateIncomeCategories={()=>{}} />
       </ContentModal>

       <PaywallModal open={activeModal === 'paywall'} onClose={() => setActiveModal(null)} onUpgrade={() => navigateTo('pricing')} />
       <MobileMenu isOpen={activeModal === 'menu_mobile'} onClose={() => setActiveModal(null)} onNavigate={navigateTo} isPro={isPro} onUpgrade={() => navigateTo('pricing')} />
    </div>
  );
}
export default App;